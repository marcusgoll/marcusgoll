# Data Model: 049-performance-optimization

## Summary

**No database changes required** - This feature is a pure frontend performance optimization.

All optimizations are implemented at the:
- **Build level**: Bundle analysis, code splitting, font optimization
- **Runtime level**: Web Vitals tracking, dynamic imports, lazy loading
- **Infrastructure level**: Compression, HTTP/2, caching headers

---

## Analytics Data (GA4 Custom Events)

While no database changes are needed, this feature introduces new **GA4 custom event tracking** for Web Vitals metrics.

### Web Vitals Events (GA4)

**Event Schema**:
```typescript
interface WebVitalEvent {
  event_name: 'web_vitals';
  metric_name: 'FCP' | 'LCP' | 'CLS' | 'TTFB' | 'INP';
  metric_value: number;
  metric_rating: 'good' | 'needs-improvement' | 'poor';
  metric_delta: number;
  page_path: string;
  user_agent: string; // Browser info
}
```

**Example Event Payload**:
```json
{
  "event_name": "web_vitals",
  "metric_name": "LCP",
  "metric_value": 2100,
  "metric_rating": "good",
  "metric_delta": 2100,
  "page_path": "/blog/example-post",
  "user_agent": "Mozilla/5.0..."
}
```

**GA4 Configuration**:
- **Custom Events**: web_vitals (event name)
- **Custom Parameters**: metric_name, metric_value, metric_rating, metric_delta
- **Data Retention**: 14 months (GA4 default)
- **Privacy**: No PII collected, user_agent anonymized by GA4

**GA4 Custom Report Structure**:
```
Dimensions:
- metric_name (FCP, LCP, CLS, TTFB, INP)
- metric_rating (good, needs-improvement, poor)
- page_path (URL)

Metrics:
- Event count (total measurements)
- Average metric_value (avg performance)
- 75th percentile metric_value (p75 performance)
- 95th percentile metric_value (p95 performance)

Filters:
- metric_rating = 'good' (Good metrics only)
- metric_rating != 'good' (Needs attention)
```

---

## Performance Budget Configuration

**File**: `lighthouserc.json`

**Structure**:
```json
{
  "ci": {
    "collect": {
      "numberOfRuns": 3,
      "url": [
        "http://localhost:3000",
        "http://localhost:3000/blog/example-post"
      ]
    },
    "assert": {
      "assertions": {
        "categories:performance": ["error", {"minScore": 0.9}],
        "first-contentful-paint": ["error", {"maxNumericValue": 1800}],
        "largest-contentful-paint": ["error", {"maxNumericValue": 2500}],
        "cumulative-layout-shift": ["error", {"maxNumericValue": 0.1}],
        "total-blocking-time": ["error", {"maxNumericValue": 200}],
        "max-potential-fid": ["warn", {"maxNumericValue": 100}],
        "speed-index": ["warn", {"maxNumericValue": 3400}],
        "interactive": ["error", {"maxNumericValue": 3800}]
      }
    },
    "upload": {
      "target": "temporary-public-storage"
    }
  }
}
```

**Rationale**:
- Runs Lighthouse 3 times, takes median score (reduces variance)
- Tests homepage and blog post (representative pages)
- Fails CI if Performance < 90 (enforces quality gate)
- Uploads reports to temporary storage (viewable via GitHub Actions)

---

## Bundle Analysis Data

**File**: `.next/analyze/client.html` (generated by @next/bundle-analyzer)

**Data Captured**:
- **Chunk sizes**: Main bundle, route chunks, shared chunks
- **Dependency tree**: Visualizes which packages contribute to bundle size
- **Duplicate dependencies**: Identifies opportunities for deduplication

**Example Output**:
```
Chunk: main-app
Size: 180 KB (gzipped: 65 KB)
Top dependencies:
- react: 45 KB
- next: 30 KB
- framer-motion: 25 KB
- @radix-ui/react-dialog: 15 KB
- tailwindcss: 10 KB
```

**Action Items from Analysis**:
- If framer-motion > 30KB → Investigate usage, consider alternatives
- If duplicate React versions → Fix peer dependency issues
- If unused code detected → Add tree-shaking annotations

---

## Font Loading State

**Next.js Font API** generates optimized font files and CSS variables.

**Generated CSS Variables**:
```css
:root {
  --font-work-sans: 'Work Sans', 'Work Sans Fallback', system-ui, sans-serif;
  --font-jetbrains-mono: 'JetBrains Mono', 'JetBrains Mono Fallback', 'Courier New', monospace;
}
```

**Font File Structure**:
```
public/_next/static/media/
├── work-sans-latin-400.woff2       # Regular weight, Latin subset
├── work-sans-latin-600.woff2       # Semibold weight
├── work-sans-latin-700.woff2       # Bold weight
└── jetbrains-mono-latin-400.woff2  # Monospace for code blocks
```

**Optimization Details**:
- **Subsetting**: Only Latin characters (reduces file size by ~60%)
- **Format**: WOFF2 only (best compression, supported by all modern browsers)
- **Display**: font-display: swap (prevents FOIT, shows fallback until font loads)
- **Preloading**: Next.js automatically adds `<link rel="preload">` for critical fonts

---

## No Database Schema Changes

**Entities**: None (no new database tables)

**Migrations**: None required

**Data Retention**: N/A

**Backup Strategy**: N/A (performance optimizations don't affect data)

---

## Configuration Files Summary

| File | Purpose | Format | Location |
|------|---------|--------|----------|
| `lighthouserc.json` | Lighthouse CI budgets | JSON | Root directory |
| `.next/analyze/` | Bundle analysis reports | HTML/JSON | Build output (gitignored) |
| `app/fonts.ts` | Font configuration | TypeScript | Application code |
| `next.config.ts` | Bundle analyzer config | TypeScript | Root directory |

---

## Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│ User visits page                                            │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ Next.js Server (SSG/ISR)                                    │
│ - Serves pre-rendered HTML                                  │
│ - Injects font CSS variables                                │
│ - Includes optimized font files                             │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ Browser (Client-side)                                       │
│ 1. Parse HTML (FCP measured)                                │
│ 2. Load CSS (fonts via font-display: swap)                  │
│ 3. Load JavaScript chunks (main + route-specific)           │
│ 4. Execute React (LCP measured)                             │
│ 5. Lazy load Dialog component (if user clicks)              │
│ 6. Track Web Vitals → GA4                                   │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│ Google Analytics 4                                          │
│ - Stores web_vitals events                                  │
│ - Aggregates metrics (p50, p75, p95)                        │
│ - Custom reports for performance monitoring                 │
└─────────────────────────────────────────────────────────────┘
```

---

## Performance Metrics Storage

**Short-term** (Browser):
- Web Vitals measured via Performance API
- Metrics buffered in memory until page unload
- Sent to GA4 as batch events

**Long-term** (GA4):
- web_vitals events stored for 14 months
- Aggregated daily for reporting
- Accessible via GA4 API or dashboard

**No server-side storage** - all metrics client-side or in GA4.
