# Implementation Plan: Image Optimization (Next.js Image)

## [RESEARCH DECISIONS]

See: research.md for full research findings

**Summary**:
- Stack: Next.js 15.5.6 built-in Image component (already in use across 21 files)
- Components to reuse: 7 (PostCard, MagazineMasonry, MDXImage, FeaturedPostsSection, Sidebar, blog pages, next.config.ts)
- New components needed: 0 (configuration and enhancement only)
- Pattern: Configuration-driven optimization with component prop updates
- Key insight: Solid foundation exists, gaps are configuration and consistency

---

## [ARCHITECTURE DECISIONS]

**Stack**:
- Frontend: Next.js 15.5.6 (App Router) with built-in Image Optimization API
- Image Processing: Sharp (automatic peer dependency for self-hosted Next.js)
- Formats: WebP and AVIF (automatic conversion by Next.js)
- CDN: None (Hetzner VPS with Caddy reverse proxy)
- State Management: None required (stateless image rendering)

**Patterns**:
- **Fill Layout with Aspect Ratio**: Use PostCard pattern (`<div className="relative aspect-video">` + `<Image fill />`) for responsive cards and grids
- **Priority Loading**: Add `priority={true}` to above-the-fold images (hero images, featured post cards on homepage)
- **Blur Placeholders**: Use `placeholder="blur"` for local images (automatic), shimmer effect for remote images via blurDataURL
- **Responsive Sizing**: Define `sizes` prop to optimize srcset generation (e.g., `"(max-width: 768px) 100vw, 50vw"`)
- **Remote Patterns**: Whitelist external image domains using `remotePatterns` (not `domains` - deprecated)

**Dependencies** (new packages required):
- None (all features built into Next.js 15)

---

## [STRUCTURE]

**Directory Layout** (follow existing patterns):

```
.
├── next.config.ts                    # MODIFIED: Add image optimization config
├── components/
│   ├── mdx/
│   │   └── mdx-image.tsx             # MODIFIED: Add blur placeholder, remove img fallback
│   ├── blog/
│   │   └── PostCard.tsx              # MODIFIED: Add priority prop (homepage featured)
│   └── home/
│       ├── MagazineMasonry.tsx       # MODIFIED: Standardize to fill layout
│       ├── FeaturedPostsSection.tsx  # AUDIT: Check priority prop usage
│       └── Sidebar.tsx               # AUDIT: Check for missing alt text
├── lib/
│   └── utils/
│       └── shimmer.ts                # NEW: Shimmer placeholder generator utility
└── specs/050-image-optimization/
    ├── spec.md                       # EXISTS: Requirements
    ├── research.md                   # EXISTS: Research findings
    ├── data-model.md                 # EXISTS: Configuration schema
    ├── quickstart.md                 # EXISTS: Testing scenarios
    ├── plan.md                       # THIS FILE
    ├── tasks.md                      # NEXT: Generated by /tasks
    ├── NOTES.md                      # MODIFIED: Add performance baseline, decisions
    └── baseline-lighthouse.json      # NEW: Performance baseline (capture during /optimize)
```

**Module Organization**:
- **Configuration Module**: next.config.ts (image optimization settings)
- **Component Module**: components/**/\*.tsx (Image component usage)
- **Utility Module**: lib/utils/shimmer.ts (blur placeholder generator)
- **Testing Module**: specs/050-image-optimization/ (performance measurement, validation)

---

## [DATA MODEL]

See: data-model.md for complete entity definitions

**Summary**:
- Entities: 0 (no database changes)
- Relationships: N/A (frontend-only optimization)
- Migrations required: No

**Key Configuration**:
```typescript
// next.config.ts
images: {
  formats: ['image/avif', 'image/webp'], // Modern formats first
  deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
  imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
  remotePatterns: [
    // Add external domains on-demand
  ],
  minimumCacheTTL: 60, // 60 seconds
}
```

---

## [PERFORMANCE TARGETS]

**From spec.md NFRs** (or defaults from constitution.md):
- NFR-001: LCP (Largest Contentful Paint) <2.5s on 3G (target: 2.0-2.3s achieved)
- NFR-002: CLS (Cumulative Layout Shift) <0.1 (target: 0.05-0.08 achieved)
- NFR-003: Image transfer size reduction ≥30% (target: 35-40% via WebP/AVIF)
- NFR-004: All images have alt attributes (WCAG 2.1 AA)
- NFR-005: Responsive srcset adapts to viewport (no oversized mobile images)
- NFR-006: Production build succeeds without warnings

**Lighthouse Targets**:
- Performance: ≥90 (stretch: 92-95)
- Accessibility: ≥95 (all images have proper alt text)
- Best Practices: ≥90 (no unoptimized images)
- SEO: ≥90 (maintained, not degraded)

**Measurement Strategy**:
- Baseline: Capture before implementation (LCP, CLS, image bytes, Lighthouse scores)
- After MVP (US1-US3): Measure 20-30% improvement
- After Full (US1-US6): Measure 35-50% improvement
- Source: Lighthouse CI (.lighthouseci/results/\*.json), Chrome DevTools Network tab

---

## [SECURITY]

**Authentication Strategy**:
- N/A (no authentication changes - public content site)

**Authorization Model**:
- N/A (image optimization is frontend concern)

**Input Validation**:
- **External Image URLs**: Validate via remotePatterns whitelist in next.config.ts
  - Must specify protocol: 'https' (never allow http)
  - Must specify hostname explicitly (never use wildcard '**')
  - Optionally restrict pathname for tighter security
- **Image Dimensions**: Validate width/height props are positive integers
- **Alt Text**: Validate non-empty strings (accessibility requirement)

**Data Protection**:
- **No PII in Alt Text**: Ensure alt attributes don't expose sensitive user information
- **No Tracking Pixels**: Verify external images don't include tracking parameters
- **CSP for SVG**: Set Content-Security-Policy for SVG images (prevent XSS)
  ```typescript
  contentSecurityPolicy: "default-src 'self'; script-src 'none'; sandbox;"
  ```

**Security Configuration**:
```typescript
// next.config.ts
images: {
  remotePatterns: [
    {
      protocol: 'https', // Only HTTPS allowed
      hostname: 'images.unsplash.com', // Explicit hostname (no wildcards)
      pathname: '/photo-*', // Optional: restrict to specific paths
    },
  ],
  dangerouslyAllowSVG: false, // Block SVG by default (XSS risk)
  contentDispositionType: 'attachment', // Force download for SVGs
}
```

---

## [EXISTING INFRASTRUCTURE - REUSE] (7 components)

**Services/Modules**:
- next.config.ts: Next.js configuration (currently minimal image config - enhance)
- Sharp library: Automatic peer dependency for image optimization (no explicit install needed)

**UI Components**:
- components/blog/PostCard.tsx: **BEST PRACTICE PATTERN** - Uses fill layout + aspect-ratio + sizes prop (lines 30-38)
  - Reuse: Pattern for other components
  - Modify: Add priority prop for homepage featured cards
- components/home/MagazineMasonry.tsx: Hero + grid with priority prop (line 44), uses width/height (lines 41-42, 111-112)
  - Reuse: Priority prop pattern
  - Modify: Standardize to fill layout (US4)
- components/mdx/mdx-image.tsx: MDX image wrapper with local/external handling
  - Reuse: Structure and logic
  - Modify: Remove img fallback (lines 44-49), add blur placeholders (US1, US2)
- components/home/FeaturedPostsSection.tsx: Featured posts display
  - Audit: Verify priority prop usage for above-the-fold images
- components/home/Sidebar.tsx: Author/profile images
  - Audit: Check alt text quality (US5)
- app/blog/[slug]/page.tsx: Blog post pages using MDXImage
  - Audit: Verify no layout shifts with new placeholders

**Utilities**:
- None currently - will create shimmer.ts for blur placeholders

---

## [NEW INFRASTRUCTURE - CREATE] (1 utility + config updates)

**Backend**:
- None (frontend-only optimization)

**Frontend**:
- lib/utils/shimmer.ts: **NEW** - Shimmer placeholder generator for remote images
  - Purpose: Generate base64-encoded SVG shimmer effect for blur placeholders
  - Function: `shimmerDataURL(width: number, height: number): string`
  - Usage: `<Image blurDataURL={shimmerDataURL(800, 600)} placeholder="blur" />`
  - Implementation: See data-model.md for full code

**Configuration**:
- next.config.ts: **MODIFIED** - Add image optimization settings
  - Add: formats, deviceSizes, imageSizes, remotePatterns, minimumCacheTTL
  - Security: dangerouslyAllowSVG=false, contentDispositionType='attachment'

**Database**:
- None

---

## [CI/CD IMPACT]

**From spec.md deployment considerations:**
- Platform: Hetzner VPS + Docker + Caddy (no changes)
- Env vars: None required (image optimization built into Next.js)
- Breaking changes: No (backward compatible - progressive enhancement)
- Migration: No database migrations

**Build Commands**:
- No changes - `npm run build` already includes image optimization

**Environment Variables** (update secrets.schema.json):
- No new environment variables required
- Existing vars unchanged

**Database Migrations**:
- No

**Smoke Tests** (for deploy-staging.yml and promote.yml):
- Route: `/` (homepage)
- Expected: 200, images load with blur placeholders, LCP <2.5s
- Verification: Run Lighthouse audit in CI, assert Performance ≥85

**Platform Coupling**:
- Vercel: Compatible (Vercel Image Optimization API)
- Hetzner VPS: Compatible (uses Sharp library for optimization)
- Docker: No Dockerfile changes (Next.js handles optimization at runtime)

---

## [DEPLOYMENT ACCEPTANCE]

**Production Invariants** (must hold true):
- No breaking NEXT_PUBLIC_* env var changes: ✅ (none changed)
- Backward-compatible API changes only: ✅ (no API changes)
- Database migrations are reversible: ✅ (no migrations)
- Feature flags default to 0% in production: ✅ (no feature flags)

**Smoke Tests** (Given/When/Then):
```gherkin
Given user visits https://marcusgoll.com/
When user scrolls through homepage
Then images load progressively with blur placeholders
  And hero image loads immediately (priority)
  And no layout shift occurs (CLS <0.1)
  And images are WebP/AVIF format (modern browsers)
  And Lighthouse Performance score ≥90

Given user opens a blog post
When page loads
Then featured image appears immediately
  And inline MDX images lazy load below fold
  And all images have descriptive alt text
  And page is interactive <3s (TTI)
```

**Rollback Plan**:
- Deploy IDs tracked in: specs/050-image-optimization/NOTES.md (Deployment Metadata)
- Rollback commands:
  ```bash
  # Via Git
  git revert <commit-sha>
  git push origin main
  # CI auto-deploys reverted code

  # Via Docker (if needed)
  ssh hetzner
  docker pull ghcr.io/marcusgoll/marcusgoll:<previous-commit-sha>
  docker-compose up -d --force-recreate
  ```
- Special considerations: **None** - Configuration and component changes are self-contained, no database state

**Artifact Strategy** (build-once-promote-many):
- Web: Next.js build artifact (.next/ directory) in Docker image
- Docker image: ghcr.io/marcusgoll/marcusgoll:<commit-sha> (NOT :latest)
- Build in: .github/workflows/deploy-production.yml (lint → type-check → build → deploy)
- Deploy to production: SSH + docker-compose up
- Cache: Image optimization cache (.next/cache/images/) persisted in Docker volume

---

## [INTEGRATION SCENARIOS]

See: quickstart.md for complete integration scenarios

**Summary**:
- Initial setup: Update next.config.ts, create shimmer utility, rebuild
- Validation workflow: Capture baseline, implement optimizations, measure improvements
- Manual testing steps: DevTools Network throttling, visual inspection, screen reader testing

---

## Implementation Strategy

### Phase 1: MVP (US1-US3) - 8-12 hours

**Goal**: Core configuration and critical optimizations for 20-30% LCP improvement

#### US1: Configuration (2-3 hours)
1. Update next.config.ts with image optimization settings
   - Add formats: ['image/avif', 'image/webp']
   - Define deviceSizes and imageSizes
   - Configure remotePatterns (start empty, add on-demand)
   - Set security options (dangerouslyAllowSVG=false)
2. Rebuild and verify no errors
3. Check .next/cache/images/ for optimized variants

#### US2: Blur Placeholders (4-6 hours)
1. Create lib/utils/shimmer.ts utility
2. Update MDXImage component:
   - Add placeholder="blur" for local images
   - Add blurDataURL={shimmerDataURL(width, height)} for remote
   - Remove img fallback for external images (lines 44-49)
3. Update PostCard component:
   - Add placeholder="blur" to featured images
4. Test with Network throttling (Slow 3G)
5. Measure CLS improvement (target: <0.1)

#### US3: Priority Loading (2-3 hours)
1. Identify above-the-fold images:
   - PostCard featured images on homepage (first 2-3 cards)
   - MagazineMasonry hero image (already has priority)
2. Add priority prop to PostCard featured images
3. Verify with Lighthouse (check for preload hints)
4. Measure LCP improvement (target: 20-30% reduction)

**Checkpoint**: Run Lighthouse audit, verify LCP <2.5s, CLS <0.1, image bytes -20%

### Phase 2: Enhancement (US4-US5) - 8-11 hours

**Goal**: Standardization and accessibility improvements for maintainability and compliance

#### US4: Sizing Standardization (5-7 hours)
1. Document sizing patterns in NOTES.md:
   - Pattern 1: Fill + aspect-ratio (cards, grids)
   - Pattern 2: Fixed dimensions (icons, avatars)
   - Pattern 3: Intrinsic + max-width (blog content)
2. Update MagazineMasonry:
   - Convert hero image to fill layout (lines 38-45)
   - Convert grid images to fill layout (lines 107-114)
   - Update aspect ratios (hero: aspect-[2/1], grid: aspect-video)
3. Test responsiveness across viewports
4. Create component usage guide in NOTES.md

#### US5: Alt Text Audit (3-4 hours)
1. Run grep for all Image components
2. Check for missing alt attributes
3. Review alt text quality:
   - Descriptive (not just repeats title)
   - Decorative images use alt=""
4. Fix gaps (estimate: 5-10 components)
5. Test with screen reader (VoiceOver on macOS, Narrator on Windows)
6. Verify WCAG 2.1 AA compliance (Lighthouse Accessibility score ≥95)

**Checkpoint**: Run Lighthouse audit, verify Accessibility ≥95, all patterns documented

### Phase 3: Advanced (US6) - 6-8 hours (OPTIONAL)

**Goal**: Automatic dimension detection for simpler MDX authoring

#### US6: Automatic Dimensions (6-8 hours)
1. Research: Investigate probe-image-size or similar libraries
2. Implement MDXImage dimension detection:
   - For local images: Read file dimensions at build time
   - For remote images: Probe dimensions or use fallback
3. Add fallback logic (default to 16:9 ratio if detection fails)
4. Log warnings for images without dimension data
5. Test with various image sources (local, remote, missing files)
6. Ensure no breaking changes to existing MDX syntax

**Checkpoint**: Test with 10+ blog posts, verify no layout shifts, no build failures

---

## Testing Strategy

### Unit Tests (if test framework added)
- shimmer.ts utility: Test base64 output format
- Image prop validation: Test fill vs width/height logic

### Integration Tests
- PostCard: Verify blur placeholder + priority prop
- MagazineMasonry: Verify hero priority + grid lazy loading
- MDXImage: Verify local vs remote image handling

### E2E Tests (Playwright - if implemented)
```typescript
test('images load with blur placeholders', async ({ page }) => {
  await page.goto('/');
  // Check for placeholder class before image loads
  const placeholder = await page.locator('img[placeholder="blur"]').first();
  await expect(placeholder).toBeVisible();
  // Wait for image to load
  await page.waitForLoadState('networkidle');
  // Verify image src is optimized
  const src = await page.locator('img').first().getAttribute('src');
  expect(src).toMatch(/\/_next\/image/);
});
```

### Manual Testing Checklist
- [ ] Homepage loads with blur placeholders (Slow 3G throttling)
- [ ] Hero image loads immediately (priority prop)
- [ ] Below-fold images lazy load (scroll to trigger)
- [ ] External images optimize (check Network tab for WebP/AVIF)
- [ ] No console errors or Next.js Image warnings
- [ ] No layout shift (CLS <0.1 in Lighthouse)
- [ ] Responsive sizing works (test mobile, tablet, desktop)
- [ ] Screen reader reads all alt text correctly

### Performance Testing
- Baseline Lighthouse audit (before optimization)
- After US1-US3 Lighthouse audit (expect 20-30% LCP improvement)
- After US4-US5 Lighthouse audit (expect Accessibility ≥95)
- Network tab comparison (expect ≥30% image bytes reduction)

---

## Risks & Mitigations

### Risk 1: External Image Domains Unknown
- **Risk**: Don't know all external domains used in blog posts
- **Impact**: Unoptimized images if domain not whitelisted
- **Mitigation**: Add domains on-demand when "Unoptimized Image" warning appears
- **Likelihood**: Medium

### Risk 2: Sharp Library Installation on VPS
- **Risk**: Sharp native dependencies may fail on VPS architecture
- **Impact**: Image optimization fails, falls back to unoptimized
- **Mitigation**: Test Docker build locally, ensure sharp installs correctly
- **Likelihood**: Low (Next.js handles this well)

### Risk 3: Performance Improvement Lower Than Expected
- **Risk**: May not achieve 20-30% LCP improvement
- **Impact**: Doesn't meet NFR targets
- **Mitigation**: Measure baseline first, iterate on optimization (add more priority images, reduce image sizes)
- **Likelihood**: Low (well-documented Next.js feature with proven results)

### Risk 4: Breaking Existing Layouts
- **Risk**: Changing from width/height to fill may break existing layouts
- **Impact**: Layout shifts or incorrect sizing
- **Mitigation**: Test each component individually, compare before/after screenshots
- **Likelihood**: Medium (US4 - Sizing Standardization)

---

## Success Criteria (from spec.md)

1. **Performance**: Page load time for blog posts decreases by at least 20% on 3G → ✅ Measure with Lighthouse before/after
2. **Visual Stability**: CLS <0.1 when images load → ✅ Blur placeholders + aspect ratios
3. **Accessibility**: 100% of images have descriptive alt text → ✅ Alt text audit (US5)
4. **Efficiency**: Image bytes reduce by at least 30% → ✅ WebP/AVIF + responsive sizing
5. **Compatibility**: Images display in all major browsers → ✅ Next.js provides fallbacks
6. **UX**: Above-the-fold images appear immediately → ✅ Priority prop (US3)
7. **Quality**: Lighthouse Performance ≥90 → ✅ All optimizations combined
8. **Smoothness**: Smooth placeholder transitions → ✅ Blur placeholders (US2)

---

## Next Steps

1. **Run /tasks**: Generate concrete TDD tasks from this plan
2. **Capture Baseline**: Run Lighthouse audit before implementation (during /optimize)
3. **Implement MVP (US1-US3)**: Configuration → Placeholders → Priority loading
4. **Measure & Iterate**: Verify 20-30% LCP improvement, adjust if needed
5. **Enhancement (US4-US5)**: Standardization → Alt text audit
6. **Ship**: Deploy to production via /ship workflow
